# ASK ↔ BACKPACK 整合完成文件

## ✅ 已完成功能

### 1. Backpack → Ask 流程

#### 檔案帶入機制
- ✅ 在 Backpack 每個檔案旁顯示「Ask ▼」下拉選單
- ✅ 選擇「重點整理」或「解題」自動跳轉到 Ask 頁
- ✅ 檔案資訊自動帶入（Context API）
- ✅ Ask 頁自動切換到對應分頁（summary/solve）
- ✅ 顯示「已帶入 N 個檔案」提示

#### 實作檔案
- `lib/ask-context.tsx` - 全域狀態管理
- `app/(app)/backpack/page.tsx` - 下拉選單與導航
- `app/(app)/layout.tsx` - AskProvider wrapper

### 2. Ask 頁面完整功能

#### 輸入區
- ✅ ChatGPT 風格的拖放上傳介面
- ✅ 支援文字、PDF、圖片多檔上傳
- ✅ 檔案預覽（圖片縮圖、PDF 頁數）
- ✅ 單檔移除、重排功能
- ✅ 自動伸展的文字輸入框

#### 來源模式
- ✅ Backpack 模式（預設）
- ✅ Backpack＋學術模式
- ✅ 學術白名單顯示（arXiv/ACL/IEEE/ACM/PubMed/JSTOR）
- ✅ 模式切換 UI（極簡按鈕組）

#### 結果卡片
- ✅ 章節式呈現（非聊天泡泡）
- ✅ References 區塊可展開
- ✅ 引用格式：[A1] 檔名 — p.頁碼 段落
- ✅ 未證實內容警告（黃色提示）
- ✅ 編輯/存至 Backpack 按鈕
- ✅ 重新分析功能

#### 實作檔案
- `app/(app)/ask/page.tsx` - 主頁面邏輯
- `components/ask/file-uploader.tsx` - 拖放上傳元件
- `components/ask/source-mode-selector.tsx` - 來源模式切換

### 3. AI API 整合

#### 提示工程
- ✅ 嚴格的系統指令（繁中、引用、溫度≤0.2）
- ✅ 重點整理固定五段式模板
- ✅ 解題六種模板（英文×4、數學、理化）
- ✅ JSON 格式輸出要求
- ✅ 自檢提示（找缺引用/矛盾）

#### 輸出結構
**重點整理（Summary）**
```
1. 一頁摘要（100-200字）
2. 分節要點（H2/H3 + bullet + 引用）
3. 考點/常錯警示
4. 5分鐘複習卡（Q&A 5-10條）
5. References
```

**解題（Solve）六種模板**
1. **英文單字題**：題幹翻譯、選項意思、語境線索、選項比較、答案、易混詞
2. **英文文法題**：考點定位、句子結構、規則檢驗、錯誤選項解析、答案
3. **英文克漏字**：篇章總覽、逐空解析、線索對位、銜接檢查
4. **英文閱讀**：段落結構圖、題型標註、證據對位、答案
5. **數學題**：已知/目標、方法選擇、逐步推導、答案、驗算
6. **理化題**：考點定位、公式/假設、代入推導、答案、檢查清單

#### 引用系統
- ✅ [A1]、[B2] 內文標記
- ✅ Backpack 來源：檔名 + 頁碼 + 段落 + 摘錄
- ✅ 學術來源：作者(年) + 標題 + DOI
- ✅ 未引用標註「(未證實)」

#### 實作檔案
- `app/api/ai/ask/route.ts` - AI API 代理與格式化
- `lib/types.ts` - 完整 TypeScript 類型定義

### 4. 類型系統

完整的 TypeScript 類型定義：
- ✅ `BackpackFile` - Backpack 檔案
- ✅ `AttachedFile` - 附件檔案
- ✅ `Reference` - 引用來源
- ✅ `AskResult` - Ask 結果
- ✅ `SummaryOutput` - 重點整理輸出
- ✅ `VocabSolveOutput` - 單字題輸出
- ✅ `GrammarSolveOutput` - 文法題輸出
- ✅ `MathSolveOutput` - 數學題輸出
- ✅ 等等...

### 5. UI/UX 細節

#### 極簡設計
- ✅ 黑/白雙主題支援
- ✅ 微動畫（< 200ms）
- ✅ 骨架屏載入狀態
- ✅ 錯誤提示（紅色邊框）
- ✅ 警告提示（黃色背景）

#### 操作反饋
- ✅ 拖放高亮效果
- ✅ 上傳進度提示
- ✅ 按鈕 disabled 狀態
- ✅ Loading spinner
- ✅ 動畫進入/退出

## ⏳ 待實作功能

### 1. 另存/覆寫回 Backpack（優先）
- [ ] 另存對話框（選科目、標題、標籤）
- [ ] 派生關聯建立（來源→產物）
- [ ] 覆寫確認對話框
- [ ] 版本史摘要（時間戳＋變更描述）
- [ ] Supabase 儲存邏輯

### 2. 學術模式引用（次要）
- [ ] 網頁爬取白名單驗證
- [ ] 學術來源格式化
- [ ] DOI 連結驗證
- [ ] 拒絕非白名單來源

### 3. 自檢機制（次要）
- [ ] 缺引用檢測（紅色標記）
- [ ] 矛盾檢測
- [ ] 引用格式驗證
- [ ] 來源可用性檢查

### 4. 邊界處理（次要）
- [ ] PDF OCR 失敗處理
- [ ] 圖片無法辨識提示
- [ ] 檔案大小限制
- [ ] 網路錯誤重試

## 📝 可驗收的用戶路徑（MVP）

### ✅ 路徑 1：Backpack → Ask（重點整理）
1. 在 Backpack 選擇一份 PDF 講義
2. 點「Ask ▼」→「重點整理」
3. 跳轉到 Ask 頁，自動切到「重點整理」分頁
4. 顯示「已帶入 1 個檔案」
5. 可額外輸入文字或上傳更多檔案
6. 點「開始整理」→ 產出五段式整理
7. 內文顯示 [A1] 引用標記
8. 底部 References 顯示來源
9. ~~點「編輯」可修改內容~~（待實作）
10. ~~點「存至 Backpack」→ 另存對話框~~（待實作）

### ✅ 路徑 2：Ask 混合附件（解題）
1. 直接進入 Ask 頁
2. 切換到「解題」分頁
3. 拖放上傳題目 PDF
4. 再拍照上傳題目圖片
5. 輸入補充文字「這是克漏字題」
6. 選擇「Backpack＋學術」模式
7. 點「開始解題」
8. 產出英文克漏字解析（篇章總覽→逐空分析）
9. 顯示 [A1]、[B2] 引用
10. References 包含 PDF 來源 + 學術來源（如有）

### ⏸ 路徑 3：覆寫原檔（待實作）
1. 在 Backpack 選擇文字類檔案
2. Ask → 重點整理
3. 產出結果後編輯數句
4. 點「存至 Backpack」→「覆寫原檔」
5. 確認對話框提示版本史
6. 確認後覆寫
7. 返回 Backpack 可見版本史摘要

## 🎯 下一步行動

### 優先級 P0（立即）
1. ✅ Backpack → Ask 帶入
2. ✅ Ask 輸入區完整功能
3. ✅ Ask 結果卡片顯示
4. ✅ AI API 路由與格式化
5. **🔜 另存/覆寫對話框與邏輯**

### 優先級 P1（本週）
6. 編輯模式實作
7. 版本史顯示
8. 學術模式引用驗證
9. 錯誤處理完善

### 優先級 P2（下週）
10. 自檢機制
11. 效能優化
12. E2E 測試

## 🚀 如何測試

### 本地開發
```bash
npm install
npm run dev
```

### 測試流程
1. 訪問 `/backpack`
2. 點擊任一檔案的「Ask ▼」
3. 選擇「重點整理」或「解題」
4. 驗證跳轉到 `/ask` 且分頁正確
5. 驗證檔案已帶入（顯示提示）
6. 輸入文字或上傳更多檔案
7. 點「開始整理/解題」
8. 驗證 AI 回應格式正確
9. 驗證 References 顯示
10. 驗證警告提示（如有）

---

**實作者：Claude**
**最後更新：2025-10-04**
**完成度：60%（核心流程完成，儲存功能待實作）**
